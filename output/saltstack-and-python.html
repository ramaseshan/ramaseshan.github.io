<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>"SaltStack and Python" â€” voidspace scribbles here</title>
	<meta name="description" content="Title: "SaltStack and Python"; Date: 2015-04-02; Author: Voidspace">
	<meta name="author" content="Voidspace">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
		<script src="/theme/html5.js"></script>
		<![endif]-->
	<link href="/theme/css/ipython.css" rel="stylesheet">
	<!--<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">-->
	<link href="/theme/css/bootstrap.min.css" rel="stylesheet">
	<link href="/theme/css/local.css" rel="stylesheet">
	<link href="/theme/css/pygments.css" rel="stylesheet">
</head>
<body>

<div class="container">
<nav class="navbar navbar-default">
<div class="container-fluid">
  <div class="navbar-header">
    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="/">voidspace scribbles here</a>
  </div>

  <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
    <ul class="nav navbar-nav navbar-right">
      <li><a href="/">Home</a></li>
      <li><a href="/blog">Blog</a></li>
      <li><a href="/Presentations">Presentations</a></li>
      <li><a href="/projects">Projects</a></li>
      <li><a href="/about">About</a></li>
    </ul>
  </div>
</div>
</nav>	<div class="row">
		<div class="col-md-8 col-md-offset-2">
<div class="article" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="text-center article-header">
		<h1 itemprop="name headline" class="article-title">"SaltStack and Python"</h1>
		<span itemprop="author" itemscope itemtype="http://schema.org/Person">
			<h4 itemprop="name">Voidspace</h4>
		</span>
		<time datetime="2015-04-02T00:04:26-04:00" itemprop="datePublished">Thu 02 April 2015</time>
	</div>
	<div>
		Category:
		<span itemprop="articleSection">
			<a href="/category/misc.html" rel="category">misc</a>
		</span>
	</div>
 
	<div>
		Tags:
		<span itemprop="keywords">
			<a href="/tag/technology.html" rel="tag">[technology</a>
		</span>
		<span itemprop="keywords">
			<a href="/tag/saltstack.html" rel="tag">saltstack</a>
		</span>
		<span itemprop="keywords">
			<a href="/tag/python.html" rel="tag">python</a>
		</span>
		<span itemprop="keywords">
			<a href="/tag/saltapi.html" rel="tag">saltapi</a>
		</span>
		<span itemprop="keywords">
			<a href="/tag/salt-basics.html" rel="tag">salt-basics]</a>
		</span>
	</div>
	<div itemprop="articleBody" class="article-body"><p>SaltStack is a infrastructure management tool, that is scalable ( can manage up to thousands of servers ) and written in python. Salt also does a lot of remote execution and configuration management too.</p>
<p>The official docs can be found here : http://docs.saltstack.com/en/latest/</p>
<p>This post is going to talk about how to use SaltStack with python. We at Fractalio Data, heavily rely on SaltStack for various operations. We basically build Data Storage Servers, and we want to regulary keep package updates running on all the servers, manage configurations, get status and resource utiliation of each individual nodes, restart services incase of failures, transfer log and other files between nodes and more. Apart from the development team, our testing team is completely automated using SaltStack. We have automated the test suite for one server, and same test suite is executed on all the servers parallely and the final results and gathered from all the servers and mined for all useful data.</p>
<p>We will discuss a basic usage of SaltStack with python. </p>
<p>{% highlight css %}
Pre-requisites :
    1. You should have installed Salt master and have atleast one salt minion.
    2. You should have received the minion request on the master (not necessarily accepted)
    3. You should be the root user or the user who has access to salt. It will be defined in the master config (/etc/salt/master grep for user)
    4. This code has to be run on the same machine as Salt master.</p>
<p>{% endhighlight %}</p>
<p>Open the terminal and go to the python console typing python</p>
<p>We will use the Salt wheel client to accept the minions. Wheels are used for interating with various parts of salt.</p>
<p _="%" endhighlight="endhighlight">This will get all the pending minions to be accepted.
{% highlight python %}
         import salt.wheel
         opts = salt.config.master_config('/etc/salt/master') #The path of your salt master configuration
         wheel = salt.wheel.Wheel(opts) # Initialize the wheel with various salt opts
         keys = wheel.call_func('key.list_all')<br />
         pending_minions = keys['minions_pre']
         print pending_minions</p>
<p _="%" endhighlight="endhighlight">{% highlight python %}
        for m in pending_minions:
            try:
                if not wheel.call_func('key.accept', match=('%s'%m)): 
                    print "Error accepting Minion key for %s "%m
                    return -1
            except Exception, e:
                print "Error accepting Minion key for %s : %s"%(m, e)
                return -1
            else:
                return 0</p>
<p>Viola ! And you are done accepting the minions. Lets first test if the minions are accepted properly and explore more on what the above code is doing.</p>
<p _="%" endhighlight="endhighlight">{% highlight python %}
    &gt;&gt;&gt; import salt.client
    &gt;&gt;&gt; client = salt.client.LocalClient()
    &gt;&gt;&gt; client.cmd('*','test.ping')
    {'Seshan@fractalio': True}  # Yay, the minion has responded.</p>
<p>So lets now explore more of what the above code is doing.</p>
<p>In the first code block, we had these lines :
    keys = wheel.call_func('key.list_all')<br />
    pending_minions = keys['minions_pre']</p>
<ul>
<li>The keys variable will contain all the keys that the salt master contains. Irrespective of if they are accepted or not accpeted or rejected, the keys variable will contain all the information.</li>
<li>The pending_minions will contain all the not accepted minions. Why is called minions_pre, why not minions_pending ?? Do an <strong> ls /etc/salt/pki/master/ </strong> , and you will figure out.</li>
</ul>
<p>The second code block :
    wheel.call_func('key.accept', match=('%s'%m))</p>
<ul>
<li>The above code says the wheel client to passes 'accept' request and the minion key as an argument to the call_func. The whole if condition and the and try blocks are basic python to safely handle the failed cases and etc.</li>
</ul>
<p>You have got the basic hello world working. Now lets explore more on this, shall we.
 Read more here.  ramaseshan.github.io/technology/2015/04/02/saltstack-and-python-more-operations/</p></div>
	<hr>
	<h2>Comments</h2>
</div>
		</div>
	</div> 	<!-- <hr> -->
</div> <!-- /container -->
<footer class="aw-footer bg-danger">
	<div class="container">
		<div class="row">
			<div class="col-md-12 text-center center-block aw-bottom">
				<p>&copy; Voidspace 2014</p>
				<p>Powered by Pelican</p>
			</div>
		</div>
	</div>
</footer>
<!-- JavaScript -->
<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<script type="text/javascript">
jQuery(document).ready(function($) {
	$("div.collapseheader").click(function () {
		$header = $(this).children("span").first();
		$codearea = $(this).children(".input_area");
		$codearea.slideToggle(500, function () {
			$header.text(function () {
				return $codearea.is(":visible") ? "Collapse Code" : "Expand Code";
			});
		});
	});
});
</script>
</body>
</html>